<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GH ‚Äì Initialization</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            margin: 0; padding: 20px;
        }

        .setup-card {
            width: 100%; max-width: 500px; background: #111; border: 1px solid #333;
            border-radius: 16px; padding: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }

        /* PROGRESS BAR */
        .progress-track {
            display: flex; gap: 10px; margin-bottom: 30px; justify-content: center;
        }
        .step-dot {
            width: 10px; height: 10px; border-radius: 50%; background: #333;
            transition: 0.3s;
        }
        .step-dot.active { background: var(--gh-blue); box-shadow: 0 0 10px var(--gh-blue); }
        .step-dot.done { background: var(--gh-yellow); }

        /* CONTENT STEPS */
        .step-content { display: none; text-align: center; animation: fadeIn 0.5s ease; }
        .step-content.active { display: block; }

        h1 { font-size: 24px; color: #fff; margin: 0 0 10px; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #888; font-size: 14px; line-height: 1.6; margin-bottom: 25px; }

        .gh-input { width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        
        .btn-row { display: flex; justify-content: space-between; margin-top: 30px; }
        .ghost-btn { background: transparent; border: none; color: #666; cursor: pointer; font-weight: bold; }
        .ghost-btn:hover { color: #fff; }

        /* AVATAR UPLOADER (Updated) */
        .av-wrapper {
            position: relative; width: 100px; height: 100px; margin: 0 auto 20px; 
            cursor: pointer; border-radius: 50%; overflow: hidden;
            border: 2px solid var(--gh-blue); transition: 0.3s;
        }
        .av-wrapper:hover { border-color: var(--gh-yellow); box-shadow: 0 0 15px rgba(253, 255, 85, 0.3); }
        
        .av-preview { width: 100%; height: 100%; object-fit: cover; background: #000; }
        
        .av-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 10px; font-weight: bold; text-transform: uppercase;
            opacity: 0; transition: 0.2s;
        }
        .av-wrapper:hover .av-overlay { opacity: 1; }

        /* FEATURE ICONS */
        .feat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px; }
        .feat-item { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .feat-icon { font-size: 20px; margin-bottom: 5px; }
        .feat-title { color: #fff; font-weight: bold; font-size: 12px; }
        .feat-desc { color: #666; font-size: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="setup-card">
        <div class="progress-track">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
            <div class="step-dot" id="dot3"></div>
        </div>

        <div class="step-content active" id="step1">
            
            <input type="file" id="pfpInput" accept="image/*" style="display:none;" onchange="uploadPfp()">
            
            <div class="av-wrapper" onclick="document.getElementById('pfpInput').click()">
                <img src="assets/GH_Hero.png" class="av-preview" id="userAv">
                <div class="av-overlay">Change</div>
            </div>

            <h1>Identity</h1>
            <p>Establish your callsign. Click the avatar to upload a custom image.</p>
            
            <input type="text" id="inName" class="gh-input" placeholder="Display Name">
            <input type="text" id="inBio" class="gh-input" placeholder="Short Bio / Status">
            
            <div class="btn-row" style="justify-content: flex-end;">
                <button class="gh-btn" onclick="nextStep(2)">NEXT ></button>
            </div>
        </div>

        <div class="step-content" id="step2">
            <h1>The Network</h1>
            <p>GH is a modular ecosystem. Here is your equipment.</p>
            
            <div class="feat-grid">
                <div class="feat-item">
                    <div class="feat-icon">üè†</div>
                    <div class="feat-title">Dashboard</div>
                    <div class="feat-desc">Your central command. News, stats, and quick links.</div>
                </div>
                <div class="feat-item">
                    <div class="feat-icon">üéÆ</div>
                    <div class="feat-title">The Arcade</div>
                    <div class="feat-desc">Social games, leaderboards, and the Clicker.</div>
                </div>
                <div class="feat-item">
                    <div class="feat-icon">üí¨</div>
                    <div class="feat-title">Comms</div>
                    <div class="feat-desc">Global chats and private encrypted DMs.</div>
                </div>
                <div class="feat-item">
                    <div class="feat-icon">üåç</div>
                    <div class="feat-title">Community</div>
                    <div class="feat-desc">Forums, content feeds, and finding squads.</div>
                </div>
            </div>

            <div class="btn-row">
                <button class="ghost-btn" onclick="nextStep(1)">< BACK</button>
                <button class="gh-btn" onclick="nextStep(3)">NEXT ></button>
            </div>
        </div>

        <div class="step-content" id="step3">
            <h1>Protocol</h1>
            <p>By entering GH, you agree to maintain the vibe.</p>
            
            <ul style="text-align: left; color:#ccc; font-size:13px; margin-bottom:20px; padding-left:20px;">
                <li style="margin-bottom:10px;">Respect other agents. Zero tolerance for toxicity.</li>
                <li style="margin-bottom:10px;">No spamming the comms channels.</li>
                <li style="margin-bottom:10px;">Have fun. Build cool stuff.</li>
            </ul>

            <button class="gh-btn btn-secondary" style="width:100%; margin-bottom:20px; border:1px dashed #444;" onclick="window.open('guide.html', '_blank')">üìò READ FIELD MANUAL</button>

            <div class="btn-row">
                <button class="ghost-btn" onclick="nextStep(2)">< BACK</button>
                <button class="gh-btn btn-primary" style="background:var(--gh-yellow); color:#000;" onclick="finishSetup()">INITIALIZE SYSTEM</button>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script src="firebase-init.js"></script>

    <script>
        let currentUser = null;
        let uploadedAvatarUrl = null;

        auth.onAuthStateChanged(async user => {
            if(!user) return window.location.href = "login.html";
            currentUser = user;
            
            // Pre-fill
            const doc = await db.collection("users").doc(user.uid).get();
            if(doc.exists) {
                const d = doc.data();
                if(d.name) document.getElementById("inName").value = d.name;
                if(d.bio) document.getElementById("inBio").value = d.bio;
                if(d.photoURL) {
                    document.getElementById("userAv").src = d.photoURL;
                    uploadedAvatarUrl = d.photoURL; // Keep existing if not changed
                }
            }
        });

        function nextStep(step) {
            // Validation Step 1
            if(step === 2) {
                const name = document.getElementById("inName").value.trim();
                if(!name) return alert("Callsign required.");
            }

            // Visuals
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');

            // Dots
            document.querySelectorAll('.step-dot').forEach((d, i) => {
                d.classList.remove('active', 'done');
                if(i + 1 === step) d.classList.add('active');
                if(i + 1 < step) d.classList.add('done');
            });
        }

        async function uploadPfp() {
            const file = document.getElementById("pfpInput").files[0];
            if(!file || !currentUser) return;

            const avImg = document.getElementById("userAv");
            // Show loading state (opacity)
            avImg.style.opacity = "0.5";

            try {
                // Upload to storage using global 'storage' var
                const ref = storage.ref(`avatars/${currentUser.uid}`);
                await ref.put(file);
                uploadedAvatarUrl = await ref.getDownloadURL();
                
                // Update preview
                avImg.src = uploadedAvatarUrl;
                avImg.style.opacity = "1";
            } catch(e) {
                console.error(e);
                alert("Upload failed. Try a smaller image.");
                avImg.style.opacity = "1";
            }
        }

        async function finishSetup() {
            if(!currentUser) return;
            const btn = document.querySelector(".btn-primary");
            btn.innerText = "PROCESSING...";
            
            const name = document.getElementById("inName").value.trim();
            const bio = document.getElementById("inBio").value.trim();

            try {
                // Update Firestore
                await db.collection("users").doc(currentUser.uid).set({
                    name: name,
                    bio: bio,
                    photoURL: uploadedAvatarUrl || currentUser.photoURL, // Use new, or old, or auth default
                    setupComplete: true, 
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Update Auth Profile
                await currentUser.updateProfile({ 
                    displayName: name,
                    photoURL: uploadedAvatarUrl || currentUser.photoURL
                });

                window.location.href = "gh_dashboard.html";
            } catch(e) {
                alert("Error: " + e.message);
                btn.innerText = "INITIALIZE SYSTEM";
            }
        }
    </script>
</body>
</html>