<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GH ‚Äì Community</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="drawer.css">

    <style>
        /* =========================================
           V2 AMBIENCE
        ========================================= */
        :root { --gh-yellow: #fdff55; --gh-blue: #00eaff; --gh-red: #ff4444; }
        body { margin: 0; background: #000; color: #fff; font-family: Arial, sans-serif; overflow-x: hidden; display: flex; flex-direction: column; animation: fadeInPage 0.6s ease-out forwards; opacity: 0; }
        @keyframes fadeInPage { to { opacity: 1; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--gh-blue); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gh-yellow); }

        body::before { background: radial-gradient(circle at 20% 15%, #00eaff33 0%, transparent 60%); filter: blur(90px); content: ""; position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        body::after { background: radial-gradient(circle at 80% 85%, #fdff5533 0%, transparent 70%); filter: blur(110px); content: ""; position: fixed; inset: 0; z-index: -2; pointer-events: none; }
        .particles { position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; }
        .particle { position: absolute; width: 3px; height: 3px; background: #ffffff22; border-radius: 50%; animation: drift 12s linear infinite; filter: blur(1px); }
        @keyframes drift { 0% { transform: translate(0,0); opacity: 0.2; } 50% { opacity: 0.3; } 100% { transform: translate(20px, -120vh); opacity: 0; } }

        /* LAYOUT */
        .page-wrap { display: flex; min-height: calc(100vh - 70px); }
        .content { flex-grow: 1; padding: 25px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-title { font-size: 32px; font-weight: 700; margin-bottom: 25px; color: var(--gh-yellow); text-shadow: 0 0 10px #fdff5544; border-bottom: 2px solid var(--gh-yellow); display: inline-block; padding-bottom: 5px; }
        .bento-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        
        .bento-card { background: #111; border: 2px solid var(--gh-blue); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 0 15px #00eaff22; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; box-sizing: border-box; }
        .bento-card:hover { transform: translateY(-2px); box-shadow: 0 0 25px #00eaff44; }
        
        .card-header { font-size: 18px; font-weight: bold; color: var(--gh-yellow); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; text-shadow: 0 0 5px #fdff5544; }
        .header-btn { background: transparent; border: 1px solid var(--gh-blue); color: var(--gh-blue); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-left: 5px; }
        .header-btn:hover { background: var(--gh-blue); color: #000; }
        
        .admin-controls { display: flex; align-items: center; gap: 5px; }
        .admin-gear { border-color: var(--gh-yellow); color: var(--gh-yellow); display: none; }
        .admin-gear:hover { background: var(--gh-yellow); color: #000; transform: rotate(90deg); }
        .admin-eye { border-color: #fff; color: #fff; display: none; }
        .admin-eye:hover { background: #fff; color: #000; }

        .countdown-text { font-size: 11px; color: #fff; background: #333; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-weight: normal; letter-spacing: 0.5px; text-transform: none; border: 1px solid #555; }

        /* WIDGETS */
        .event-card { border-color: var(--gh-yellow); box-shadow: 0 0 15px #fdff5522; grid-column: 1 / -1; background: linear-gradient(45deg, #111 0%, #1a1a00 100%); }
        .event-card:hover { box-shadow: 0 0 25px #fdff5544; }
        .event-card .card-header { color: var(--gh-yellow); }
        .event-content { display: flex; align-items: center; gap: 20px; }
        .event-icon { font-size: 40px; }
        .event-text h3 { margin: 0 0 5px 0; color: #fff; font-size: 22px; }
        .event-text p { margin: 0; opacity: 0.8; }
        .event-join-btn { background: var(--gh-yellow); color: #000; border: none; padding: 10px 20px; font-weight: bold; border-radius: 6px; cursor: pointer; margin-left: auto; box-shadow: 0 0 10px #fdff5566; transition: 0.2s; }
        .event-join-btn:hover { box-shadow: 0 0 20px var(--gh-yellow); transform: scale(1.05); }
        .event-card.inactive { filter: grayscale(1); opacity: 0.7; border-color: #444; }
        .event-card.inactive .event-join-btn { display: none; }
        .event-card.inactive .card-header { color: #888; border-bottom-color: #333; }

        .briefing-card { height: 660px; display: flex; flex-direction: column; }
        .news-feed { overflow-y: auto; flex-grow: 1; padding-right: 5px; scrollbar-width: thin; scrollbar-color: var(--gh-blue) #111; }
        .news-item { display: flex; gap: 15px; padding: 15px; border-radius: 8px; margin-bottom: 12px; background: #1a1a1a; transition: 0.2s; text-decoration: none; color: #fff; border-left: 3px solid transparent; }
        .news-item:hover { background: #222; transform: translateX(5px); border-left: 3px solid var(--gh-yellow); }
        .news-info h4 { margin: 0 0 6px 0; font-size: 15px; color: var(--gh-blue); }
        .news-info p { margin: 0; font-size: 12px; opacity: 0.6; }

        .poll-card { border-color: var(--gh-blue); margin-bottom: 0; flex-shrink: 0; transition: 0.3s; }
        .poll-question { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .poll-option { background: #222; padding: 12px; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; border: 1px solid #444; transition: 0.2s; margin-bottom: 8px; }
        .poll-option:hover { border-color: var(--gh-yellow); }
        .poll-option.voted { border-color: #00eaff; box-shadow: 0 0 10px #00eaff55; background: #001a1a; }
        .poll-bar { position: absolute; left: 0; top: 0; bottom: 0; background: #fdff5533; width: 0%; transition: width 0.5s ease; z-index: 1; }
        .poll-text { position: relative; z-index: 2; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        
        .poll-card.inactive { filter: grayscale(1); opacity: 0.8; border-color: #444; pointer-events: none; }
        .poll-card.inactive .card-header { color: #888; border-bottom-color: #333; }
        .poll-card.inactive .header-btn { pointer-events: auto; } 

        .yapps-card { display: flex; flex-direction: column; border-color: var(--gh-yellow); box-shadow: 0 0 15px #fdff5522; flex-grow: 1; overflow: hidden; }
        .mini-posts { display: flex; flex-direction: column; gap: 15px; flex-grow: 1; justify-content: flex-start; overflow-y: hidden; }
        .mini-post-item { background: #1a1a1a; padding: 14px; border-radius: 8px; border-left: 3px solid var(--gh-yellow); transition: 0.2s; }
        .mini-post-item:hover { background: #222; transform: translateX(5px); }
        .mini-post-user { font-size: 13px; font-weight: bold; color: var(--gh-blue); margin-bottom: 4px; }
        .mini-post-text { font-size: 14px; opacity: 0.9; line-height: 1.4; }
        .view-all-link { text-align: center; display: block; margin-top: auto; color: var(--gh-blue); font-size: 13px; font-weight: bold; text-decoration: none; padding: 12px; border-radius: 6px; background: #111; border: 1px solid #333; }
        .view-all-link:hover { background: #222; border-color: var(--gh-blue); }
        .right-col { display: flex; flex-direction: column; gap: 30px; height: 660px; }

        @media (max-width: 900px) {
            .bento-grid { grid-template-columns: 1fr; }
            .right-col { height: auto !important; }
            .briefing-card { height: 500px; }
            .content { padding: 15px; }
            .event-content { flex-direction: column; text-align: center; }
            .event-join-btn { margin: 10px auto 0 auto; width: 100%; }
            .page-title { font-size: 26px; }
        }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-content { background: #111; border: 2px solid var(--gh-yellow); border-radius: 12px; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 0 25px #fdff5544; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin-top: 0; color: var(--gh-yellow); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: bold; color: var(--gh-blue); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; background: #222; border: 1px solid #555; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #333; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; }
        .btn-save { background: var(--gh-yellow); color: #000; border: none; padding: 10px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #ff4444; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-right: auto; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .checkbox-group input { width: auto; transform: scale(1.3); }
        .checkbox-group label { margin: 0; color: #fff; }

        .file-drop-area { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .file-drop-area:hover { border-color: var(--gh-blue); background: #1a1a1a; }
        .file-msg { color: #888; font-size: 13px; }
        .entry-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; margin-top: 15px; }
        .entry-item { background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #333; text-align: center; position: relative; }
        .entry-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #555; }
        .delete-btn { position: absolute; top: -8px; right: -8px; background: #ff4444; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #111; box-shadow: 0 0 5px rgba(0,0,0,0.5); font-size: 12px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #111; border: 1px solid #00eaff; color: #00eaff; padding: 10px 20px; border-radius: 99px; opacity: 0; pointer-events: none; transition: 0.3s ease; box-shadow: 0 0 15px #00eaff44; z-index: 9999; font-weight: bold; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* THEME SUPPORT */
        body.light-mode { background: #f4f4f4; color: #222; }
        body.light-mode::before, body.light-mode::after { opacity: 0.5; }
        body.light-mode .bento-card { background: #fff; border-color: #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        body.light-mode .page-title { color: #d4d700; border-color: #d4d700; text-shadow: none; }
        body.light-mode .card-header { color: #333; border-bottom-color: #eee; text-shadow: none; }
        body.light-mode .header-btn { border-color: #999; color: #555; }
        body.light-mode .news-item, body.light-mode .mini-post-item { background: #f9f9f9; color: #333; }
        body.light-mode .poll-option { background: #f9f9f9; border-color: #ddd; color: #000; }
        body.light-mode .poll-question { color: #000; }
        body.light-mode .modal-content { background: #fff; border-color: #ccc; }
        body.light-mode .modal-content h2 { color: #000; }
        body.light-mode .form-group input, body.light-mode .form-group textarea { background: #eee; color: #000; border-color: #ccc; }

        body.christmas-mode { background: #051405; color: #fff; }
        body.christmas-mode::before { background: radial-gradient(circle at 20% 15%, #ff000033 0%, transparent 60%); }
        body.christmas-mode::after { background: radial-gradient(circle at 80% 85%, #00ff6a33 0%, transparent 70%); }
        body.christmas-mode .page-title { color: #ff4444; border-color: #00ff6a; text-shadow: 0 0 10px #ff0000; }
        body.christmas-mode .bento-card { border-color: #ff4444; box-shadow: 0 0 15px #ff000033; }
        body.christmas-mode .card-header { color: #00ff6a; text-shadow: 0 0 5px #00ff6a; }
        body.christmas-mode .header-btn { border-color: #00ff6a; color: #00ff6a; }
        body.christmas-mode .header-btn:hover { background: #00ff6a; color: #000; }
        body.christmas-mode .poll-bar { background: #ff444455; }
        body.christmas-mode .poll-option:hover { border-color: #00ff6a; }
        body.christmas-mode .poll-option.voted { border-color: #ff4444; box-shadow: 0 0 10px #ff000055; background: #220000; }
        body.christmas-mode .mini-post-item { border-left-color: #ff4444; }

    </style>
</head>

<body>
    <div class="particles" id="particleContainer"></div>

    <div id="header"></div>

    <div class="page-wrap">
        <div id="drawer"></div>

        <div class="content">
            <h1 class="page-title">Community Hub</h1>

            <div class="bento-grid">
                
                <div class="bento-card event-card" id="eventCard">
                    <div class="card-header">
                        <div style="display:flex; align-items:center;">
                            Community Event
                            <span id="eventCountdown" class="countdown-text" style="display:none;"></span>
                        </div>
                        <div class="admin-controls">
                            <button id="eventViewBtn" class="header-btn admin-eye" onclick="openEntriesModal()" title="View Entries">üëÅÔ∏è</button>
                            <button id="eventAdminBtn" class="header-btn admin-gear" onclick="openEventAdminModal()" title="Manage Event">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="event-content" id="eventContent">
                        <div style="opacity:0.7">Checking event satellite...</div>
                    </div>
                </div>

                <div class="bento-card briefing-card">
                    <div class="card-header">
                        The Daily Briefing
                        <button class="header-btn" onclick="fetchNews()" title="Refresh News">‚ü≥</button>
                    </div>
                    <div class="news-feed" id="newsFeed">
                        <div style="text-align:center; padding:20px; opacity:0.6;">Connecting to Satellite...</div>
                    </div>
                </div>

                <div class="right-col">
                    
                    <div class="bento-card poll-card" id="pollCard">
                        <div class="card-header">
                            <div style="display:flex; align-items:center;">
                                Poll of the Week
                                <span id="pollCountdown" class="countdown-text" style="display:none;"></span>
                            </div>
                            <button id="pollAdminBtn" class="header-btn admin-gear" onclick="openPollModal()" title="Edit Poll">‚öôÔ∏è</button>
                        </div>
                        <div id="pollContainer">
                            <div class="poll-question">Loading Poll...</div>
                        </div>
                    </div>

                    <div class="bento-card yapps-card">
                        <div class="card-header">Recent Yapps</div>
                        <div class="mini-posts" id="miniPosts"></div>
                        <a href="posts.html" class="view-all-link">View All Posts ‚Üí</a>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="pollModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Manage Poll</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="pollActive">
                <label for="pollActive">Poll is Active</label>
            </div>
            <div class="form-group"><label>Question</label><input type="text" id="editPollQ" placeholder="e.g. Best Game?"></div>
            <div class="form-group"><label>Option 1</label><input type="text" id="editPollOpt1"></div>
            <div class="form-group"><label>Option 2</label><input type="text" id="editPollOpt2"></div>
            <div class="form-group"><label>Option 3</label><input type="text" id="editPollOpt3"></div>
            <div class="form-group"><label>End Date/Time</label><input type="datetime-local" id="editPollTimer"></div>
            <p style="color:#ff4444; font-size:12px; margin:0;">*Saving resets all votes to 0.</p>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="document.getElementById('pollModal').style.display='none'">Cancel</button>
                <button class="btn-save" onclick="saveNewPoll()">Reset & Save</button>
            </div>
        </div>
    </div>

    <div id="eventAdminModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Manage Event</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="evtActive">
                <label for="evtActive">Event is Active</label>
            </div>
            <div class="form-group"><label>Event Title</label><input type="text" id="evtTitle"></div>
            <div class="form-group"><label>Description</label><textarea id="evtDesc" rows="3"></textarea></div>
            <div class="form-group"><label>Reward (Optional)</label><input type="text" id="evtReward"></div>
            <div class="form-group"><label>Icon (Emoji)</label><input type="text" id="evtIcon" style="width:50px;"></div>
            <div class="form-group"><label>End Date/Time</label><input type="datetime-local" id="evtTimer"></div>
            <div class="modal-actions">
                <button class="btn-danger" onclick="purgeEntries()">Purge All</button>
                <button class="btn-cancel" onclick="document.getElementById('eventAdminModal').style.display='none'">Cancel</button>
                <button class="btn-save" onclick="saveEventSettings()">Save</button>
            </div>
        </div>
    </div>
    <div id="entriesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Submissions</h2>
            <div id="entriesGrid" class="entry-grid"></div>
            <div class="modal-actions">
                <button class="btn-save" onclick="document.getElementById('entriesModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>
    <div id="submissionModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Submit Entry</h2>
            <div class="file-drop-area" onclick="document.getElementById('entryFile').click()">
                <div class="file-msg">Click to select</div><input type="file" id="entryFile" accept="image/*" style="display:none" onchange="previewEntry(this)">
            </div>
            <img id="entryPreview" style="width:100%; height:150px; object-fit:cover; margin-top:10px; display:none; border-radius:6px;">
            <div class="form-group" style="margin-top:15px;">
                <label style="color:var(--gh-blue);">Caption</label>
                <input type="text" id="entryCaption" placeholder="e.g. My new base">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="document.getElementById('submissionModal').style.display='none'">Cancel</button>
                <button class="btn-save" id="btnSubmitEntry" onclick="submitEntry()">Upload</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Action Saved!</div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script src="firebase-init.js"></script>
    <script src="header.js"></script>
    <script src="drawer.js"></script>

    <script>
        /* --- VISUALS --- */
        const container = document.getElementById("particleContainer");
        for (let i = 0; i < 30; i++) {
            const p = document.createElement("div");
            p.classList.add("particle");
            p.style.left = Math.random() * 100 + "vw";
            p.style.top = Math.random() * 100 + "vh";
            p.style.animationDelay = Math.random() * 10 + "s";
            p.style.opacity = Math.random() * 0.4 + 0.1;
            p.style.transform = `scale(${Math.random() * 1 + 0.5})`;
            container.appendChild(p);
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }

        /* --- THEME LISTENER --- */
        db.collection("site_config").doc("theme").onSnapshot(doc => {
            if(doc.exists) {
                const mode = doc.data().mode;
                document.body.classList.remove('light-mode', 'christmas-mode');
                if(mode === 'light') document.body.classList.add('light-mode');
                if(mode === 'xmas') document.body.classList.add('christmas-mode');
            }
        });

        /* --- ADMIN CHECK --- */
        auth.onAuthStateChanged(async user => {
            if (user) {
                const token = await user.getIdTokenResult();
                if (token.claims.admin) {
                    document.getElementById("pollAdminBtn").style.display = "flex";
                    document.getElementById("eventAdminBtn").style.display = "flex";
                    document.getElementById("eventViewBtn").style.display = "flex";
                }
            }
        });

        /* --- POLL LOGIC --- */
        const pollDocRef = db.collection("settings").doc("poll");
        let isPollEnded = false;

        function updatePollCountdown(targetDate) {
            const el = document.getElementById("pollCountdown");
            if (!targetDate) { el.style.display = "none"; return false; }
            const diff = new Date(targetDate).getTime() - new Date().getTime();
            if (diff < 0) {
                el.style.display = "block"; el.innerText = "ENDED"; el.style.color = "#ff4444";
                return true; 
            }
            const days = Math.floor(diff / (86400000));
            const hours = Math.floor((diff % (86400000)) / (3600000));
            el.style.display = "block"; el.style.color = "#fff";
            el.innerText = `Ends in: ${days}d ${hours}h`;
            return false;
        }

        pollDocRef.onSnapshot(async doc => {
            const container = document.getElementById("pollContainer");
            const card = document.getElementById("pollCard");
            
            if (!doc.exists) { container.innerHTML = "<div style='padding:10px;'>No poll.</div>"; return; }
            
            const data = doc.data();
            const timerExpired = updatePollCountdown(data.endsAt);
            
            if (!data.isActive || timerExpired) {
                card.classList.add("inactive");
                isPollEnded = true;
                if(!data.isActive && !timerExpired) container.innerHTML = `<div class="poll-question" style="color:#888;">${data.question || 'Poll'} (Closed)</div>`;
            } else {
                card.classList.remove("inactive");
                isPollEnded = false;
            }

            let myVote = null;
            if (auth.currentUser) {
                const voteSnap = await db.collection("poll_votes").doc(auth.currentUser.uid).get();
                if(voteSnap.exists) myVote = voteSnap.data().choice;
            }

            const v1 = Math.max(0, data.votes1 || 0);
            const v2 = Math.max(0, data.votes2 || 0);
            const v3 = Math.max(0, data.votes3 || 0);
            const totalVotes = v1 + v2 + v3;
            
            let html = `<div class="poll-question">${data.question || "Poll"}</div>`;
            
            const buildBar = (text, votes, idx) => {
                if(!text) return '';
                const percent = totalVotes === 0 ? 0 : Math.round((votes / totalVotes) * 100);
                const isMyVote = myVote === idx ? "voted" : ""; 
                return `<div class="poll-option ${isMyVote}" onclick="castVote('${idx}')">
                    <div class="poll-bar" style="width: ${percent}%"></div>
                    <div class="poll-text"><span>${text}</span><span>${percent}%</span></div>
                </div>`;
            };
            
            html += buildBar(data.opt1, v1, 'votes1');
            html += buildBar(data.opt2, v2, 'votes2');
            html += buildBar(data.opt3, v3, 'votes3');
            
            if(!card.classList.contains('inactive') || timerExpired) container.innerHTML = html;
        });

        async function castVote(newChoice) {
            if(isPollEnded) return alert("Poll is closed.");
            if(!auth.currentUser) return alert("Login to vote.");
            const uid = auth.currentUser.uid;
            const voteRef = db.collection("poll_votes").doc(uid);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const voteDoc = await transaction.get(voteRef);
                    const pollDoc = await transaction.get(pollDocRef);
                    
                    if (!pollDoc.exists) throw "Poll does not exist!";
                    
                    if (voteDoc.exists) {
                        const oldChoice = voteDoc.data().choice;
                        if (oldChoice === newChoice) return; 

                        transaction.update(pollDocRef, {
                            [oldChoice]: firebase.firestore.FieldValue.increment(-1),
                            [newChoice]: firebase.firestore.FieldValue.increment(1)
                        });
                        transaction.update(voteRef, { choice: newChoice, timestamp: Date.now() });
                        showToast("Vote Switched");
                    } else {
                        transaction.update(pollDocRef, {
                            [newChoice]: firebase.firestore.FieldValue.increment(1)
                        });
                        transaction.set(voteRef, { choice: newChoice, timestamp: Date.now() });
                        showToast("Voted");
                    }
                });
            } catch (e) {
                console.error("Vote failed: ", e);
            }
        }

        function openPollModal() {
            pollDocRef.get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById("editPollQ").value = d.question;
                    document.getElementById("editPollOpt1").value = d.opt1;
                    document.getElementById("editPollOpt2").value = d.opt2;
                    document.getElementById("editPollOpt3").value = d.opt3;
                    document.getElementById("pollActive").checked = d.isActive !== false;
                    document.getElementById("editPollTimer").value = d.endsAt || "";
                }
            });
            document.getElementById("pollModal").style.display = "flex";
        }

        function saveNewPoll() {
            const q = document.getElementById("editPollQ").value;
            const o1 = document.getElementById("editPollOpt1").value;
            const o2 = document.getElementById("editPollOpt2").value;
            const o3 = document.getElementById("editPollOpt3").value;
            const active = document.getElementById("pollActive").checked;
            const endsAt = document.getElementById("editPollTimer").value;

            if(!q) return alert("Question required");
            if(!confirm("Reset Poll? (Clears all votes)")) return;
            
            pollDocRef.set({ 
                question: q, isActive: active, endsAt: endsAt, 
                opt1: o1, votes1: 0, 
                opt2: o2, votes2: 0, 
                opt3: o3, votes3: 0 
            }).then(() => { 
                document.getElementById("pollModal").style.display="none"; 
                showToast("Poll Reset!"); 
            });
        }

        /* --- EVENT LOGIC --- */
        function updateEventCountdown(targetDate) {
            const el = document.getElementById("eventCountdown");
            if (!targetDate) { el.style.display = "none"; return false; }
            const diff = new Date(targetDate).getTime() - new Date().getTime();
            if (diff < 0) { el.style.display = "block"; el.innerText = "ENDED"; el.style.color = "#ff4444"; return true; }
            const days = Math.floor(diff / (86400000));
            const hours = Math.floor((diff % (86400000)) / (3600000));
            el.style.display = "block"; el.style.color = "#fff"; el.innerText = `Ends in: ${days}d ${hours}h`;
            return false;
        }

        const eventDocRef = db.collection("settings").doc("challenge");
        eventDocRef.onSnapshot(doc => {
            const card = document.getElementById("eventCard");
            const content = document.getElementById("eventContent");
            if (!doc.exists) return;
            const d = doc.data();
            const isTimerEnded = updateEventCountdown(d.endsAt);
            if (!d.isActive || isTimerEnded) {
                card.classList.add("inactive");
                content.innerHTML = `<div class="event-icon">üí§</div><div class="event-text"><h3>Event Inactive</h3><p>Check back later!</p></div>`;
            } else {
                card.classList.remove("inactive");
                content.innerHTML = `<div class="event-icon">${d.icon || 'üèÜ'}</div><div class="event-text"><h3>${d.title}</h3><p>${d.description}</p>${d.reward ? `<small style="color:var(--gh-blue)">Reward: ${d.reward}</small>` : ''}</div><button class="event-join-btn" onclick="openSubmissionModal()">Submit Entry</button>`;
            }
        });

        function openEventAdminModal() { eventDocRef.get().then(doc=>{if(doc.exists){const d=doc.data();document.getElementById("evtTitle").value=d.title;document.getElementById("evtDesc").value=d.description;document.getElementById("evtReward").value=d.reward;document.getElementById("evtIcon").value=d.icon;document.getElementById("evtActive").checked=d.isActive;document.getElementById("evtTimer").value=d.endsAt;}});document.getElementById("eventAdminModal").style.display="flex";}
        function saveEventSettings() { eventDocRef.set({title:document.getElementById("evtTitle").value,description:document.getElementById("evtDesc").value,reward:document.getElementById("evtReward").value,icon:document.getElementById("evtIcon").value,isActive:document.getElementById("evtActive").checked,endsAt:document.getElementById("evtTimer").value},{merge:true}).then(()=>{document.getElementById("eventAdminModal").style.display="none";showToast("Event Updated!");});}
        function purgeEntries() { if(confirm("Delete all?")) db.collection("challenge_submissions").get().then(snap=>{const b=db.batch();snap.docs.forEach(d=>b.delete(d.ref));b.commit().then(()=>{alert("Purged");document.getElementById("eventAdminModal").style.display="none";});}); }
        function openEntriesModal() { document.getElementById("entriesModal").style.display="flex"; document.getElementById("entriesGrid").innerHTML="Loading..."; db.collection("challenge_submissions").orderBy("timestamp","desc").get().then(snap=>{document.getElementById("entriesGrid").innerHTML=""; snap.forEach(doc=>{const d=doc.data();document.getElementById("entriesGrid").innerHTML+=`<div class="entry-item"><span class="delete-btn" onclick="deleteEntry('${doc.id}','${d.imageUrl}')">üóëÔ∏è</span><a href="${d.imageUrl}" target="_blank"><img src="${d.imageUrl}"></a><div class="entry-info"><span class="entry-user">${d.userName}</span>${d.caption}</div></div>`;});}); }
        async function deleteEntry(id,url) { if(confirm("Delete?")){await db.collection("challenge_submissions").doc(id).delete(); firebase.storage().refFromURL(url).delete(); openEntriesModal();} }
        function openSubmissionModal(){if(!auth.currentUser)return alert("Login required."); document.getElementById("submissionModal").style.display="flex";}
        function previewEntry(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{document.getElementById("entryPreview").src=e.target.result;document.getElementById("entryPreview").style.display="block";};r.readAsDataURL(i.files[0]);}}
        async function submitEntry(){const f=document.getElementById("entryFile").files[0];const c=document.getElementById("entryCaption").value;if(!f||!c)return alert("Missing info"); try{const u=auth.currentUser;const r=storage.ref(`challenges/${u.uid}_${Date.now()}`);await r.put(f);const url=await r.getDownloadURL();await db.collection("challenge_submissions").add({userId:u.uid,userName:u.displayName||"User",imageUrl:url,caption:c,timestamp:Date.now()});showToast("Submitted");document.getElementById("submissionModal").style.display="none";}catch(e){alert(e.message);}}

        async function fetchNews() {
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent("https://feeds.feedburner.com/ign/games-all")}`);
                const data = await res.json();
                const feed = document.getElementById("newsFeed");
                feed.innerHTML = "";
                data.items.slice(0, 15).forEach(item => {
                    feed.innerHTML += `<a href="${item.link}" target="_blank" class="news-item"><div class="news-info"><h4>${item.title}</h4><p>${item.author || "IGN"} ‚Ä¢ ${new Date(item.pubDate).toLocaleDateString()}</p></div></a>`;
                });
            } catch(e){}
        }
        fetchNews();
        
        db.collection("posts").orderBy("timestamp", "desc").limit(3).onSnapshot(snap => {
            const c = document.getElementById("miniPosts"); c.innerHTML="";
            snap.forEach(doc => { const d=doc.data(); c.innerHTML+=`<div class="mini-post-item"><div class="mini-post-user">${d.authorName}</div><div class="mini-post-text">${d.text.substring(0,80)}...</div></div>`;});
        });
    </script>
</body>
</html>